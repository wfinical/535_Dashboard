---
title: "Deforestation"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
forest <- read_csv("../Data/forest.csv")
forest_area <- read_csv("../Data/forest_area.csv")
brazil_loss <- read_csv("../Data/brazil_loss.csv")
soybean_use <- read_csv("../Data/soybean_use.csv")
veg_oil <- read_csv("../Data/vegetable_oil.csv")

forest_all <- forest %>%
  full_join(forest_area, by = c("entity","code","year"))

options(scipen = 999)
```

Global Deforestation
=======================================================================
Inputs {.sidebar}
-------------------------------------
```{r}

```

Row {data-height=500}
-----------------------------------------------------------------------

### Percent of Global Forest Area

```{r}
globe_df <- forest_all %>% 
  filter(forest_all$entity != "World" & !is.na(forest_all$code)) %>% 
  rename(`Percent of Global Forest` = forest_area,
         `Net Change in Forest` = net_forest_conversion,
         Year = year)

fig1 <- plot_geo() %>%
  add_trace(data = globe_df,
            z = ~`Percent of Global Forest`,
            text = globe_df$entity, 
            hovertemplate = "%{text}: %{z:.2r}%", 
            locations = globe_df$code,
            frame = ~Year,
            zauto = FALSE,
            zmax = 20,
            colors = "YlGn") %>%
  layout(geo = list(showocean = TRUE,
                    showland = TRUE,
                    showlakes = TRUE,
                    oceancolor = 'aliceblue',
                    landcolor = 'grey',
                    lakecolor = 'blue',
                    projection = list(type = "orthographic")),
         showlegend = TRUE)

fig1
```


### Net Change in Forest Area

```{r}
fig2 <- plot_geo() %>%
  add_trace(data = globe_df,
            z = ~`Net Change in Forest`,
            text = globe_df$entity, 
            hovertemplate = "%{text}: %{z:.2s}",
            locations = globe_df$code,
            frame = ~Year,
            zauto = FALSE,
            zmax = 2500000,
            zmid = 0,
            zmin = -4000000,
            colors = "RdYlGn") %>%
  layout(geo = list(showocean = TRUE,
                    showland = TRUE,
                    showlakes = TRUE,
                    oceancolor = 'aliceblue',
                    landcolor = 'grey',
                    lakecolor = 'blue',
                    projection = list(type = "orthographic")),
         showlegend = TRUE)
         
fig2
#subplot(fig1, fig2)
```

Row {data-height=500}
-----------------------------------------------------------------------

### Percentage of Global Forest Area

```{r}
usa <- forest_area %>%
  filter(code == "USA") %>%
  mutate(pct_change = (forest_area/lag(forest_area) - 1) * 100)
usa$forest_area <- round(usa$forest_area, 1)

usa_plot <- usa %>%
  plot_ly(
    domain = list(x = c(0, 1), y = c(0, 1)),
    value = ~forest_area,
    title = list(text = "U.S.:1990-2020"),
    frame = ~year,
    type = "indicator",
    mode = "gauge+number",
    gauge = list(axis =list(range = list(NULL, 20)),
                 threshold = list(
                   line = list(color = "red", width = 4),
                   thickness = 0.75,
                   value = 7.1)))

usa_plot <- usa_plot %>%
  layout(margin = list(l=20,r=30))

usa_plot
```

### Percentage of Global Forest Area

```{r}
chn <- forest_area %>%
  filter(code == "CHN") %>%
  mutate(pct_change = (forest_area/lag(forest_area) - 1) * 100)
chn$forest_area <- round(chn$forest_area, 1)

china_plot <- chn %>%
  plot_ly(
    domain = list(x = c(0, 1), y = c(0, 1)),
    value = ~forest_area,
    title = list(text = "China:1990-2020"),
    frame = ~year,
    type = "indicator",
    mode = "gauge+number",
    gauge = list(axis =list(range = list(NULL, 20)),
                 threshold = list(
                   line = list(color = "red", width = 4),
                   thickness = 0.75,
                   value = 3.7)))

china_plot <- china_plot %>%
  layout(margin = list(l=20,r=30))

china_plot
```

### Percentage of Global Forest Area

```{r}
bra <- forest_area %>%
  filter(code == "BRA") %>%
  mutate(pct_change = (forest_area/lag(forest_area) - 1) * 100)
bra$forest_area <- round(bra$forest_area, 1)

brazil_plot <- bra %>%
  plot_ly(
    domain = list(x = c(0, 1), y = c(0, 1)),
    value = ~forest_area,
    title = list(text = "Brazil:1990-2020"),
    frame = ~year,
    type = "indicator",
    mode = "gauge+number",
    gauge = list(axis =list(range = list(NULL, 20)),
      threshold = list(
        line = list(color = "red", width = 4),
        thickness = 0.75,
        value = 13.9)))

brazil_plot <- brazil_plot %>%
  layout(margin = list(l=20,r=30))

brazil_plot
```

Brazil Deforestation
==========================================================================

```{r}
library(dygraphs)
brazil_loss %>% 
  mutate(Agriculture = (cumsum(commercial_crops + pasture + 
                                 tree_plantations_including_palm)/1000000), 
         Infrastructure = (cumsum(flooding_due_to_dams + 
                                    other_infrastructure + roads)/1000000), 
         Lumber = (cumsum(selective_logging + small_scale_clearing)/1000000), 
         Mining = (cumsum(mining)/1000000), 
         Fire = (cumsum(fire)/1000000), 
         `Natural Disturbances` = I(cumsum(natural_disturbances)/1000000)) %>% 
  select(year, Agriculture, Infrastructure, Lumber, Mining, Fire, 
         `Natural Disturbances`) %>% 
  dygraph(main = "Cumulative Deforestation by Industry - Brazil",
          x = "Year", 
          y = "Forest Area Lost (million Hectares)") %>% 
  dyRangeSelector() %>% 
  dyOptions(stackedGraph = TRUE) %>% 
  dyLegend(show = "follow")
```

